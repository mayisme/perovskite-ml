# 分子性质预测与模型分析平台

## 📋 项目概述

这是一个基于 Streamlit 构建的交互式分子性质预测与模型分析平台，专门用于预测钙钛矿太阳能电池材料的功率转换效率（PCE）。该平台集成了先进的机器学习模型、分子指纹计算、SHAP可解释性分析和批量处理功能，为研究人员提供了一个完整的分子设计和分析工具。

## 🎯 主要功能

### 1. 分子性质预测
- **单次预测**：支持单个或多个SMILES字符串的PCE预测
- **批量预测**：支持批量处理多个分子预测任务
- **智能SMILES解析**：支持复杂的分子表示格式（点分分子、分号分隔等）

### 2. 模型性能分析
- **性能指标展示**：MSE、RMSE、MAE、R²等关键指标
- **预测结果可视化**：实际值vs预测值对比图、残差分布图
- **特征重要性分析**：展示影响模型预测的关键特征

### 3. SHAP可解释性分析
- **SHAP摘要图**：展示特征对模型输出的整体影响
- **SHAP热力图**：显示特征值与SHAP值的关系
- **SHAP小提琴图**：展示特征重要性分布
- **SHAP箱线图**：显示前10个最重要特征的SHAP值分布

### 4. 数据处理与导出
- **多种数据格式支持**：JSON、CSV格式导出
- **基准行选择**：基于PCE性能智能选择基准分子
- **批量处理**：支持大文件的后台处理和进度显示

## 🛠️ 技术栈

### 核心框架
- **Streamlit**：Web应用框架，提供交互式用户界面
- **Python 3.x**：主要编程语言

### 数据处理与科学计算
- **Pandas**：数据处理和分析
- **NumPy**：数值计算
- **RDKit**：化学信息学工具包，用于分子指纹计算
- **Scikit-learn**：机器学习评估指标

### 可视化
- **Plotly**：交互式图表
- **Matplotlib**：基础绘图库
- **Seaborn**：统计可视化
- **SHAP**：模型可解释性分析

### 机器学习
- **XGBoost**：梯度提升决策树模型
- **CatBoost**：梯度提升决策树模型（用于6.py）
- **Joblib**：模型序列化和加载

## 📁 项目结构

```
/Users/xiaoyf/Documents/Python/perovskite/
├── prs.py                    # 主应用程序文件（基于Streamlit的分子性质预测平台）
├── 1.py                      # XGBoost模型性能评估脚本
├── 6.py                      # 基于CatBoost的钙钛矿添加剂性能预测应用
├── 3.csv                     # 训练数据集
├── best_model.cbm           # CatBoost训练好的模型文件
├── output_20250826_130253/   # XGBoost模型输出目录
│   ├── trained_model_xgboost.pkl         # 训练好的XGBoost模型
│   ├── evaluation_results_xgboost.csv     # 模型评估结果
│   ├── feature_importance_xgboost.csv    # 特征重要性数据
│   └── model_predictions_xgboost.csv     # 模型预测结果
├── shap_plots/              # SHAP分析图表输出目录
└── README.md                # 项目文档
```

## 🚀 安装与运行

### 环境要求
- Python 3.7+
- 推荐使用虚拟环境

### 安装依赖
```bash
pip install streamlit pandas numpy rdkit-pypi joblib matplotlib seaborn scikit-learn shap plotly catboost zhipuai
```

### 运行应用
```bash
# 运行主应用（prs.py）
streamlit run prs.py

# 运行CatBoost应用（6.py）
streamlit run 6.py

# 运行模型评估（1.py）
python 1.py
```

应用将在默认浏览器中打开，访问地址通常是 `http://localhost:8501`

## 📖 使用指南

### 📄 脚本文件说明

#### 1.py - XGBoost模型性能评估脚本
这是一个简单的模型评估脚本，用于计算XGBoost模型的性能指标：

**主要功能：**
- 读取模型预测结果文件 (`model_predictions_xgboost.csv`)
- 计算关键性能指标：
  - R²分数（决定系数）
  - 均方误差（MSE）
  - 均方根误差（RMSE）

**使用方法：**
```bash
python 1.py
```

**输出：**
- R²分数：衡量模型拟合优度
- RMSE：预测误差的标准差

#### 6.py - 基于CatBoost的钙钛矿添加剂性能预测应用
这是一个功能完整的Streamlit应用，专门用于钙钛矿添加剂性能预测和实验设计：

**主要功能：**
- **数据预处理**：自动加载和清理数据，处理ASCII字符编码问题
- **数据集划分**：按7:2:1比例自动划分训练集、验证集和测试集
- **模型加载**：加载预训练的CatBoost模型 (`best_model.cbm`)
- **交互式预测**：
  - 基准样本选择（PCE > 20的高性能样本）
  - 化合物特征和浓度特征的实时调整
  - 即时预测结果显示
- **SHAP分析**：
  - 全局特征重要性分析
  - 个体预测解释
  - 依赖关系可视化
- **实验设计助手**：
  - 集成智谱AI GLM-4模型
  - 自动生成详细的实验设计方案
  - 包含实验步骤、参数设置、结果预测、验证方法和风险评估
- **数据导出**：
  - 预测结果导出
  - 基准样本导出
  - 实验方案导出

**使用方法：**
```bash
streamlit run 6.py
```

**特色功能：**
- 智能实验设计：基于预测结果自动生成科学实验方案
- 多维度SHAP分析：提供模型决策的深度解释
- 实时性能监控：显示训练集、验证集、测试集的性能指标

### prs.py - 主应用程序使用指南

#### 1. 基础配置
1. 启动应用后，首先在侧边栏配置PCE阈值
2. 点击"选择基准行"按钮，系统会自动选择性能最佳的基准分子
3. 选择需要显示的分析选项（预测结果可视化、模型分析）

#### 2. 单次预测
1. 切换到"单次预测"标签页
2. 在文本框中输入SMILES字符串，支持以下格式：
   - 单个SMILES：`CCO`
   - 多个SMILES（分号分隔）：`CCO;CC[NH3+]`
   - 点分分子：`Br.CC[NH3+]c1ccccc1`
3. 点击"开始预测"查看结果

#### 3. 批量预测
1. 切换到"批量预测"标签页
2. 上传包含SMILES的文本文件，格式要求：
   ```
   CCO
   CC[NH3+];Br
   Br.CC[NH3+]c1ccccc1
   ```
3. 点击"开始批量预测"，系统将后台处理并显示进度
4. 处理完成后查看结果表格和可视化图表

#### 4. 模型分析
1. 在侧边栏启用"显示模型分析"
2. 查看模型性能指标和特征重要性
3. 点击"生成SHAP分析图"进行深度可解释性分析
4. 在主界面查看不同类型的SHAP图表

#### 5. 数据导出
1. 切换到"数据导出"标签页
2. 选择导出格式（JSON或CSV）
3. 下载预测结果、基准行数据或SHAP分析图表

## 🔧 核心算法与功能

### 分子指纹计算
```python
def smiles_to_fp_list(smiles: str, mfpgen) -> List[int]:
    """将SMILES字符串转换为2048位摩根指纹"""
    # 使用RDKit的Morgan指纹生成器
    # 半径=2，指纹长度=2048位
    # 支持SMILES预处理和错误处理
```

### 多SMILES处理
```python
def merge_multiple_fps(smiles_cell, mfpgen) -> List[int]:
    """处理复杂SMILES格式"""
    # 支持分号(;)分隔的不同预测任务
    # 支持点(.)连接的分子片段
    # 支持逗号(,)分隔的多个任务
    # 使用位或操作合并多个指纹
```

### SHAP分析
```python
def generate_shap_plot(model, X_data, feature_names):
    """生成多种SHAP可视化图表"""
    # 使用TreeExplainer解释XGBoost模型
    # 合并fp_开头的特征以提高可解释性
    # 生成摘要图、热力图、小提琴图、箱线图
```

## 📊 数据格式说明

### 输入数据格式
- **SMILES字符串**：标准的化学分子表示法
- **多任务格式**：使用不同分隔符区分复杂的分子结构
- **批量文件**：纯文本格式，每行一个预测任务

### 输出数据格式
- **JSON格式**：包含任务ID、SMILES、预测PCE、变化值等
- **CSV格式**：表格化的预测结果，便于进一步分析
- **图像格式**：PNG格式的SHAP分析图表

## ⚠️ 注意事项

### 1. 数据要求
- 确保`3.csv`文件存在并包含正确的训练数据
- 模型文件路径必须正确：`output_20250826_130253/trained_model_xgboost.pkl`
- 评估数据文件必须完整
- 运行6.py需要`best_model.cbm`文件和`output_expanded_additives_pubchem_encoded.csv`文件

### 2. SMILES格式
- 输入的SMILES字符串必须符合标准格式
- 支持常见的SMILES变体，但建议使用标准格式
- 复杂分子结构建议使用分号或点号正确分隔

### 3. 性能考虑
- 批量处理大量数据时可能需要较长时间
- SHAP分析计算密集，建议在数据量适中时使用
- 确保系统有足够的内存处理大型数据集

### 4. 错误处理
- 系统包含完善的错误处理机制
- 无效的SMILES将产生警告并使用零指纹
- 处理失败的任务会记录详细的错误信息

## 🔍 故障排除

### 常见问题

**Q: 应用无法启动**
- A: 检查Python版本和依赖包是否正确安装
- A: 确认所有必需的数据文件存在

**Q: 模型加载失败**
- A: 检查模型文件路径是否正确
- A: 确认Joblib版本兼容性

**Q: SMILES解析失败**
- A: 验证SMILES字符串格式是否正确
- A: 检查是否包含特殊字符或空格

**Q: 预测结果异常**
- A: 确认基准行选择正确
- A: 检查输入数据是否与训练数据格式一致

**Q: 6.py无法找到数据文件**
- A: 确认`d:/newml/output_expanded_additives_pubchem_encoded.csv`文件存在
- A: 确认`d:/newml/best_model.cbm`文件存在
- A: 检查文件路径权限

### 性能优化建议
1. 对于大型数据集，建议分批处理
2. 定期清理临时文件和缓存
3. 在生产环境中考虑使用更强大的硬件配置

## 📈 更新日志

### 当前版本功能
- ✅ 基于XGBoost的PCE预测（prs.py）
- ✅ 基于CatBoost的添加剂性能预测（6.py）
- ✅ XGBoost模型性能评估（1.py）
- ✅ 多格式SMILES支持
- ✅ SHAP可解释性分析
- ✅ 批量处理和进度显示
- ✅ 多种数据导出格式
- ✅ 交互式可视化界面
- ✅ 智能实验设计助手（6.py）

### 计划中的功能
- 🔄 支持更多机器学习模型
- 🔄 分子结构可视化
- 🔄 实时模型训练功能
- 🔄 更多指纹计算方法
- 🔄 用户账户和项目管理

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 🤝 贡献指南

欢迎贡献代码和建议！请遵循以下步骤：

1. Fork本项目
2. 创建功能分支
3. 提交您的更改
4. 推送到分支
5. 创建Pull Request

## 📞 联系方式

如有问题或建议，请通过以下方式联系：
- 项目Issues：[GitHub Issues]
- 邮件：[您的联系方式]

---

**最后更新**：2025年9月15日

**版本**：1.0.0
